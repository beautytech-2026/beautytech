<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reserva (SPA) • BeautyTech — per-service slots (updated)</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pikaday/css/pikaday.css">
  <style>
    /* (unchanged CSS omitted for brevity in this message — it's identical to your original CSS) */
    /* Google font */
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap');
    :root{ --bg1:#d62f91; --bg2:#980370; --card: rgba(255,255,255,0.06); --accent:#ff71b8; --accent-2:#a56bff; --muted: rgba(255,255,255,0.88); --muted-2: rgba(255,255,255,0.78); --input-bg: rgba(255,255,255,0.06); --glass: rgba(255,255,255,0.04); --success:#5ce6a6; --danger:#ff7a7a; --shadow: rgba(0,0,0,0.35); --radius: 12px; --font-family: "Poppins", "Vazirmatn", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    *{box-sizing:border-box} html,body{height:100%} html { -webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; } body{ margin:0; font-family: var(--font-family); min-height:100vh; display:flex; align-items:flex-start; justify-content:center; padding:28px; background:linear-gradient(135deg,var(--bg1),var(--bg2)); color:#fff; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; line-height:1.45; font-size:16px; }
    .card{ width:100%; max-width:980px; background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02)); border: 1px solid rgba(255,255,255,0.06); border-radius:16px; padding:28px; backdrop-filter: blur(10px) saturate(1.05); box-shadow:0 18px 50px var(--shadow); margin-bottom: 40px; }
    h1{ margin:0 0 8px 0; font-size:clamp(20px, 2.6vw, 30px); line-height:1.05; text-align:center; font-weight:800; letter-spacing:0.2px; background: linear-gradient(90deg,var(--accent),var(--accent-2)); -webkit-background-clip: text; background-clip: text; color: transparent; text-shadow: 0 6px 18px rgba(243, 242, 245, 0.88); font-family: "Poppins", sans-serif; }
    p.lead{ margin:6px 0 16px; text-align:center; color: rgba(255,255,255,0.92); font-weight:500; font-size:14px; }
    .steps{display:flex;gap:10px;justify-content:center;margin-bottom:12px;flex-wrap:wrap;} .step{padding:8px 12px;border-radius:999px;background: rgba(255,255,255,0.03);font-size:11px;color: rgba(255,255,255,0.85);font-weight:700;border: 1px solid rgba(255,255,255,0.03);} .step.active{background: linear-gradient(90deg, rgba(255,113,184,0.18), rgba(165,107,255,0.12));color: #fff;transform:translateY(-2px) scale(1.03);box-shadow: 0 10px 30px rgba(165,107,255,0.12);}
    .layout{display:grid;grid-template-columns: 1fr 380px;gap:20px;align-items:start;} @media(max-width:980px){ .layout{grid-template-columns:1fr} }
    .flow-section{padding:14px;border-radius:var(--radius);background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));border: 1px solid rgba(255,255,255,0.03);}
    label{display:block;margin:10px 0 8px;font-weight:700;color: #fff;font-size:14px;letter-spacing:0.2px;}
    input[type="text"], input[type="email"], input[type="date"], select { width:100%; padding:12px 14px; border-radius:10px; border: 1px solid rgba(255,255,255,0.06); background: var(--input-bg); color: #fff; outline:none; transition: all .18s ease; font-size:14px; }
    input[type="text"]:focus, input[type="email"]:focus, input[type="date"]:focus, select:focus { box-shadow: 0 8px 30px rgba(165,107,255,0.08); border-color: rgba(255,255,255,0.12); background: rgba(255,255,255,0.08); }
    ::placeholder{ color: rgba(255,255,255,0.7); font-weight:500 }
    .small-btn{display:inline-block;padding:10px 14px;border-radius:10px;border:none;cursor:pointer;background: linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;font-weight:800;letter-spacing:0.3px;box-shadow: 0 8px 24px rgba(197,92,168,0.12);} .muted{ color: var(--muted-2); font-size:13px }
    .categories{ display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 14px } .cat{ padding:10px 14px; border-radius:12px; cursor:pointer; background: linear-gradient(180deg, rgba(142, 18, 121, 0.78), rgba(177, 15, 142, 0.75)); font-weight:700; font-size:13px; color: #f9f6f8; border: 1px solid rgba(201, 21, 138, 0.695); transition: transform .12s ease, box-shadow .12s ease; } .cat:hover{ transform: translateY(-3px); box-shadow: 0 8px 26px rgba(0,0,0,0.18) } .cat.active{ background: linear-gradient(90deg, rgba(225, 170, 198, 0.82), rgba(165,107,255,0.12)); color: #831258; box-shadow: 0 10px 30px rgba(165,107,255,0.09); border-color: rgba(149, 20, 129, 0.27); }
    .services-list{ max-height:380px; overflow:auto; padding:10px; border-radius:12px; background: rgba(0,0,0,0.06); border: 1px dashed rgba(255,255,255,0.02); } .service-row{ display:flex; justify-content:space-between; align-items:center; gap:12px; padding:12px 10px; border-bottom:1px solid rgba(255,255,255,0.03); } .service-row:last-child{ border-bottom:none } .service-name{ font-weight:700; color:#fff; font-size:15px; line-height:1.2 } .service-price{ color: #ffd6f6; min-width:96px; text-align:right; font-weight:800; font-size:14px } .add-btn{ background: transparent; border: 1px solid rgba(255, 255, 255, 0.805); color: #fff; padding:8px 12px; border-radius:10px; font-weight:800; cursor:pointer; transition: all .12s ease; } .add-btn:hover{ background: linear-gradient(90deg,var(--accent),var(--accent-2)); border-color: rgba(255, 255, 255, 0.76); box-shadow: 0 10px 30px rgba(165,107,255,0.08); }
    .summary{ padding:16px; border-radius:12px; background: linear-gradient(180deg, rgba(89, 3, 73, 0.45), rgba(0,0,0,0.06)); border: 1px solid rgba(255,255,255,0.03); min-height:160px; } .summary h4{ margin:0 0 8px; font-size:16px; color:#fff; font-weight:800 } .selected-list{ list-style:none; padding:0; margin:6px 0 0 0; max-height:320px; overflow:auto } .selected-list li{ display:flex; justify-content:space-between; align-items:center; padding:10px 8px; border-radius:10px; background: linear-gradient(180deg, rgba(213, 86, 192, 0.18), rgba(0,0,0,0.02)); margin-bottom:10px; border: 1px solid rgba(158, 55, 124, 0.18); } .selected-list li strong{ font-size:14px; display:block; margin-bottom:4px } .remove-small{ background: rgba(0,0,0,0.45); color:#fff; border:none; padding:8px 10px; border-radius:8px; cursor:pointer; font-weight:700; }
    input[type="radio"]{ width:20px; height:20px; margin-right:8px; accent-color: var(--accent); vertical-align:middle; cursor:pointer; } label > input[type="radio"] + span, label { font-size:15px; color:rgba(238, 216, 232, 0.948); display:inline-flex; align-items:center; gap:8px } label[style] { font-weight:700 }
    #datepicker{ cursor:pointer; background: linear-gradient(180deg, rgba(226, 171, 221, 0.28), rgba(255,255,255,0.02)); border: 1px solid rgba(255,255,255,0.06); padding:12px 14px; border-radius:10px; color:#dba9ea; font-weight:600; }
    .slots{ margin-top:12px } .slot-button{ display:inline-block; padding:10px 12px; border-radius:10px; border: 1px solid rgba(0,0,0,0.06); margin:6px 6px 0 0; background: linear-gradient(180deg, #fff, #fff); color: var(--accent-2); font-weight:700; cursor:pointer; transition: transform .12s ease, box-shadow .12s ease, opacity .12s ease; font-size:14px; } .slot-button:hover{ transform:translateY(-4px); box-shadow:0 12px 30px rgba(165,107,255,0.08) } .slot-button.selected{ background: linear-gradient(90deg,var(--accent),var(--accent-2)); color:#fff; box-shadow:0 12px 36px rgba(165,107,255,0.16); } .slot-button[disabled]{ opacity:0.52; cursor:not-allowed; transform:none; background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.9)); color: rgba(140,85,198,0.35); }
    .btn-primary{ background: linear-gradient(90deg,var(--accent),var(--accent-2)); color:#fff; padding:12px 18px; border-radius:12px; border:none; font-weight:800; cursor:pointer; box-shadow: 0 12px 36px rgba(165,107,255,0.12); } .btn-ghost{ background:transparent; border:1px solid rgba(255,255,255,0.06); padding:10px 14px; border-radius:10px; color:#fff; cursor:pointer; }
    .note{ font-size:13px; color: rgba(255,255,255,0.88); margin-top:12px; text-align:center } .service-picker{ background: rgba(255,255,255,0.02); padding:12px; border-radius:12px; margin-bottom:12px; border:1px solid rgba(255,255,255,0.02) } .service-picker h4{ margin:0 0 8px 0; font-size:15px; font-weight:800 }
    .hidden{ display:none } .pika-single{ border-radius:12px !important; box-shadow: 0 18px 50px rgba(0,0,0,0.45); border: none; overflow:hidden; } .pika-single .pika-title{ background: linear-gradient(90deg,var(--accent),var(--accent-2)); color:#fff; font-weight:800; padding:12px 14px } .pika-table th{ color: rgba(255,255,255,0.85); font-weight:700; background: transparent; } .pika-table td{ background: transparent; border-radius:8px; } .pika-button{ color: #222; } .pika-day.is-today{ box-shadow: inset 0 0 0 2px rgba(255,255,255,0.06); } .pika-day.is-selected{ background: linear-gradient(90deg,var(--accent),var(--accent-2)); color:#fff; border-radius:8px; box-shadow: 0 8px 26px rgba(165,107,255,0.12); }
    .back-button { position: fixed; top: 18px; left: 18px; width: 46px; height: 46px; border-radius: 50%; background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(6px); display: flex; align-items: center; justify-content: center; z-index: 999; transition: background 0.3s ease; } .back-button:hover { background: rgba(255, 255, 255, 0.3); }
    .info-icon { display: inline-block; margin-left: 6px; background: rgba(255, 255, 255, 0.476); border-radius: 50%; width: 18px; height: 18px; text-align: center; line-height: 18px; font-size: 12px; cursor: pointer; color: #ffffff; } .info-icon:hover { background: rgba(255,255,255,0.25); }
    .info-box { margin-top: 8px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.08); border-radius: 10px; padding: 10px; font-size: 13px; color: var(--muted); line-height: 1.5; transition: all 0.3s ease; }
    .logo { margin-top: 6px; margin-bottom: 18px; display: flex; justify-content: center; align-items: center; } .logo img { max-height: 84px; height: auto; width: auto; }
    @media (max-width: 780px) { body { padding:16px; } .card { padding:18px; } .logo img { max-height:72px; } .service-price { min-width:72px; font-size:13px; } .service-name { font-size:14px; } .service-row { padding:10px 6px; gap:8px; } .steps { gap:6px; } .step { padding:6px 10px; font-size:11px; } }
    @media (max-width: 560px) { .card { padding:14px; border-radius:14px; } .layout{gap:12px} .slot-button { padding:8px 10px; font-size:13px; border-radius:10px; } .small-btn, .btn-primary { padding:10px 14px; font-size:14px; } input[type="text"], input[type="email"], select { font-size:15px; padding:12px; } .selected-list li { flex-direction:column; align-items:flex-start; gap:8px; } .selected-list li > div, .selected-list li button { width:100%; } .service-price { text-align:left; color:#ffd6f6; margin-top:6px; font-weight:700; } .summary { min-height:140px; padding:12px; } }
    @media (max-width:420px) { body { font-size:15px; } h1 { font-size:20px; } .back-button { top:12px; left:12px; width:44px; height:44px; } .logo img { max-height:60px; } .service-name { font-size:13px; } .service-price { min-width:60px; font-size:13px; } .slot-button { padding:7px 8px; font-size:12px; } .muted { font-size:12px; } }
  </style>
  <script>
    function toggleInfo(el){
      const infoBox = el.parentElement.nextElementSibling;
      infoBox.classList.toggle('hidden');
    }
    function goBack(e) {
      e.preventDefault();
      if (document.referrer) {
        window.history.back();
      } else {
        window.location.href = "index1.html";
      }
    }
  </script>
</head>
<body>
  <a href="#" class="back-button" title="Voltar" onclick="goBack(event)" aria-label="Voltar">
    <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="18" height="18" aria-hidden="true">
      <circle cx="12" cy="12" r="10" />
      <polyline points="12 8 8 12 12 16" />
      <line x1="16" y1="12" x2="8" y2="12" />
    </svg>
  </a>

  <div class="card" role="main">
    <div class="logo">
      <img src="images/icon.png" alt="Logo" />
    </div>
    <h1>Formulário de Reserva • BeautyTech</h1>

    <div class="steps" aria-hidden>
      <div class="step active" id="stepLabel-1">1. Cliente</div>
      <div class="step" id="stepLabel-2">2. Serviços</div>
      <div class="step" id="stepLabel-3">3. Data & Hora (por serviço)</div>
      <div class="step" id="stepLabel-4">4. Confirmar</div>
    </div>

    <div class="layout">
      <div class="flow-section">
        <div id="step-1" class="step-block">
          <label>Escolha a sua filial:</label>
          <div style="display:flex;gap:12px;align-items:center;margin-bottom:20px;flex-wrap:wrap">
            <label style="display:flex;align-items:center;gap:6px">
              <input type="radio" name="branch" value="amora"> Beautytech Amora
            </label>
            <label style="display:flex;align-items:center;gap:6px">
              <input type="radio" name="branch" value="braga"> Beautytech Braga Retail
            </label>
          </div>

          <label>Tem o seu numero de cliente?<span class="info-icon" onclick="toggleInfo(this)" role="button" aria-label="Informação">❓</span></label>
          <div class="info-box hidden" role="region" aria-live="polite">
            Se já fez uma reserva connosco através da aplicação, recebeu o seu número de cliente.
            Caso ainda não tenha, preencha o formulário abaixo para juntar-se à nossa base de clientes — 
            Todos os agendamentos pela aplicação têm -3 euros no pagamento, e receba descontos e ofertas exclusivas!
          </div>

          <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
            <label style="display:flex;align-items:center;gap:6px"><input type="radio" name="clientType" value="old"> Sim</label>
            <label style="display:flex;align-items:center;gap:6px"><input type="radio" name="clientType" value="new"> Não</label>
            <button class="small-btn" id="clientNextBtn" disabled aria-disabled="true">Continuar</button>
          </div>

          <div id="oldCodeBox" class="hidden" style="margin-top:12px">
            <label for="clientCode">Código do cliente</label>
            <input id="clientCode" type="text" placeholder="Insira o código..." />
            <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
              <button class="small-btn" id="validateCodeBtn">Validar Código</button>
              <button class="btn-ghost" id="backToClientType1">Voltar</button>
            </div>
            <p id="codeMsg" class="muted" style="margin-top:8px"></p>
          </div>

          <form id="newClientBox" class="hidden" onsubmit="return false" style="margin-top:12px">
            <label>Nome</label><input id="name" type="text" required placeholder="Nome completo">
            <label>Email</label><input id="email" type="email" required placeholder="email@exemplo">
            <label>Telefone</label><input id="phone" type="text" required placeholder="+351 ...">
            <label>Serviço que mais usa</label>
            <select id="favService"><option>BODY TECH</option><option>FACE TECH</option><option>HAIR TECH</option><option>NAIL TECH</option><option>FACE DESIGN</option></select>
            <label>Data de nascimento</label><input id="birth" type="date" required>
            <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
              <button class="small-btn" id="newClientNext">Próximo</button>
              <button class="btn-ghost" id="backToClientType2">Voltar</button>
            </div>
          </form>
        </div>

        <div id="step-2" class="step-block hidden">
          <label>Escolha uma categoria</label>
          <div class="categories" id="categories"></div>
          <div class="services-list" id="servicesList"><p class="muted">Selecione uma categoria para ver serviços...</p></div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;flex-wrap:wrap">
            <div class="muted">Itens adicionados: <span id="countSelected">0</span></div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn-ghost" id="backToStep1From2">Voltar</button>
              <button class="btn-primary" id="toCalendarBtn">Escolher data por serviço</button>
            </div>
          </div>
        </div>

        <div id="step-3" class="step-block hidden">
          <label>Para cada serviço selecione data e hora</label>
          <div id="servicePickersWrap" style="margin-top:10px"></div>
          <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
            <button class="btn-ghost" id="backToStep2">Voltar</button>
            <button class="btn-primary" id="confirmBtn" disabled aria-disabled="true">Confirmar & Enviar</button>
          </div>
          <p id="calendarMsg" class="muted" style="margin-top:8px"></p>
        </div>

        <div id="step-4" class="step-block hidden">
          <h3 style="margin-top:0">Agradecemos por escolher os nossos serviços</h3>
          <p id="finalMsg" class="muted"></p>
          <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
            <button class="btn-ghost" id="backToStep3">Voltar</button>
            <button class="btn-primary" id="finishBtn">Voltar ao Início</button>
          </div>
        </div>
      </div>

      <aside id="resumoBox" class="summary" aria-label="Resumo" style="display:none">
        <h4>Resumo da Reserva</h4>
        <div style="margin-top:8px"><strong>Cliente</strong><div id="summaryClient" class="muted">—</div></div>
        <div style="margin-top:12px">
          <strong>Serviços selecionados</strong>
          <ul id="selectedList" class="selected-list"></ul>
          <div id="totalWrap" style="margin-top:10px;display:flex;justify-content:space-between;align-items:center">
            <div class="muted">Total estimado:</div>
            <div id="totalPrice" style="font-weight:800">0€</div>
          </div>
        </div>
        <div style="margin-top:14px"><small class="muted">Nota: Alguns serviços dizem "A partir de" — preço final pode variar em loja.</small></div>
      </aside>
    </div>

    <p class="note">Se precisar de ajuda, use o ícone de informação ao lado das perguntas.</p>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/pikaday/pikaday.js"></script>
  <script>
  (function(){
    // ------------------------------
    // WEBHOOK URLs (unchanged)
    // ------------------------------
    const WEBHOOK_VALIDATE = "https://hook.eu2.make.com/mgz53fgt82dhtfc4wnaiubjy7j5ajcjv";
    const WEBHOOK_AVAILABLE_AMORA = "https://hook.eu2.make.com/sw48l9g8shmdh766arjpngluo7pk0ja6";
    const WEBHOOK_AVAILABLE_BRAGA = "https://hook.eu2.make.com/l7ns23v63g27prryvriwikp7bh1j75vu";
    const WEBHOOK_RESERVE_AMORA = "https://hook.eu2.make.com/vs5dvcr5g9gxoea1h9ytiad98vecuyjy";
    const WEBHOOK_RESERVE_BRAGA = "https://hook.eu2.make.com/2i4jvjo24m07632lbwbduvulrpy760w3";

    // ------------------------------
    // CATEGORIES / SERVICES (unchanged content)
    // Note: you can optionally add durationMinutes/paddingMinutes here per service.
    // If not present, the code uses defaults (durationMinutes:30, paddingMinutes:0).
    // ------------------------------
    const CATEGORY_LABELS = {
      FACE_DESIGN_TECH: "FACE DESIGN",
      PERFECT_FACE_TECH: "PERFECT FACE TECH",
      PERFECT_BODY_TECH: "PERFECT BODY TECH",
      DEPILACAO_LASER: "DEPILAÇÃO LASER",
      PERFECT_NAILS_TECH: "PERFECT NAILS TECH",
      PERFECT_HAIR_TECH: "PERFECT HAIR TECH"
    };
    const CATEGORY_SUBHEADERS = {
      FACE_DESIGN_TECH: "Procedimentos de design e embelezamento facial",
      PERFECT_FACE_TECH: "Tecnologia avançada para cuidados faciais",
      PERFECT_BODY_TECH: "Tratamentos e tecnologias corporais"
    };

    // You may add durationMinutes/paddingMinutes directly in these objects.
    const SERVICES_AMORA = {
      FACE_DESIGN_TECH: [
        { name:"Embelezamento Facial e Design Personalizado", price:"150", machine: "Helena", durationMinutes:90, paddingMinutes:15 },
        { name:"Preenchimento Labial, Hy Aluron Pen", price:"120€", machine: "Helena", durationMinutes:90 },
        { name:"Micropigmentação Labial", price:"100€", machine: "Helena", durationMinutes:90 },
        { name:"Técnica Híbrida de Sobrancelhas", price:"100€", machine: "naira", durationMinutes:90 },
        { name:"Lash & Brow Lamination", price:"35€", machine: "Helena", durationMinutes:90, paddingMinutes:15 },
        { name:"Extensão de Pestanas", price:"25€", machine:"Helena", durationMinutes:90 },
        { name:"Design de Sobrancelhas & Henna", price:"15€", machine: "naira", durationMinutes:45 }
      ],
      PERFECT_FACE_TECH: [
  { name: "HIFU 12D — Rosto Completo", price: "150€", machine: "HIFU12D", durationMinutes: 60, paddingMinutes: 30 },
  { name: "HIFU 12D — Rosto + Papada", price: "250€", machine: "HIF12D", durationMinutes: 100, paddingMinutes: 30 },
  { name: "HIFU 12D — Papada", price: "70€", machine: "HIFU12D", durationMinutes: 45 },
  { name: "HIFU 12D — Pescoço", price: "70€", machine: "HIFU12D", durationMinutes: 45 },
  { name: "HIFU 12D — Rosto + Papada + Pescoço", price: "280€", machine: "HIFU12D", durationMinutes: 120, paddingMinutes: 30 },
  { name: "Limpeza de Pele", price: "25€", machine: null, durationMinutes: 30 },
  { name: "Aplicação de Fios de Seda", price: "35€", machine: "silk-threads-amora", durationMinutes: 50 },
  { name: "Booster com Dermapen", price: "a partir de 50€", machine: "dermapen", durationMinutes: 50 },
  { name: "Intradermoterapia Pressurizada", price: "a partir de 50€", machine: "pressurized-intradermotherapy", durationMinutes: 50 },
  { name: "Preenchimento Rugas Hyaluron Pen", price: "a partir de 100€", machine: "hyaluron-pen", durationMinutes: 60 }
],

      PERFECT_BODY_TECH:  [
  { name: "Massagem Modeladora e Redutora", price: "35€", machine: null, durationMinutes: 60 },
  { name: "Massagem Turbinada", price: "40€", machine: null, durationMinutes: 60 },
  { name: "Drenagem Linfática Manual", price: "40€", machine: null, durationMinutes: 60 },
 



  { name: "HIFU 12D — Barriga + Flancos", price: "380€", machine: "HIFU12D", durationMinutes: 90, paddingMinutes: 30 },
  { name: "HIFU 12D — Glúteos", price: "200€", machine: "HIFU12D", durationMinutes: 60, paddingMinutes: 30 },

  { name: "Depilação Laser Tripla Onda — Axila e Virilha", price: "20€", machine: "Laser", durationMinutes: 30 },
  { name: "Depilação Laser Tripla Onda — Axila, Virilha e Buço", price: "30€", machine: "Laser", durationMinutes: 45 },
  { name: "Depilação Laser Tripla Onda — Corpo Completo", price: "50€", machine: "Laser", durationMinutes: 90 },
  

],
      PERFECT_NAILS_TECH: [
  // --- Serviços Principais ---
  { name: "Unhas de Gel Tamanho S (com Cutilagem)", price: "27€", machine: "naira", durationMinutes: 60 },
  { name: "Unhas de Gel Tamanho M (com Cutilagem)", price: "32€", machine: "naira", durationMinutes: 75 },
  { name: "Unhas de Gel Tamanho L (com Cutilagem)", price: "35€", machine: "naira", durationMinutes: 90 },
  { name: "Unhas de Fibras (com Cutilagem)", price: "42€", machine: "naira", durationMinutes: 90 },
  { name: "Acrygel (com Cutilagem)", price: "30€", machine: "naira", durationMinutes: 75 },
  { name: "Blindagem (com Cutilagem)", price: "18€", machine: "naira", durationMinutes: 45 },
  { name: "Gelhinho Mão (com Cutilagem)", price: "12€", machine: "naira", durationMinutes: 30 },
  { name: "Gelhinho Pé (com Cutilagem)", price: "22€", machine: "naira", durationMinutes: 45 },
  { name: "Gelhinho Pé (sem Cutilagem)", price: "10€", machine: "naira", durationMinutes: 30 },

  // --- Manutenção ---
  { category: "Manutenção", name: "Unhas de Gel (com Cutilagem)", price: "a partir de 17€", machine: "naira", durationMinutes: 60 },
  { category: "Manutenção", name: "Unhas de Fibras (com Cutilagem)", price: "26€", machine: "naira", durationMinutes: 60 },
  { category: "Manutenção", name: "Acrygel (com Cutilagem)", price: "21€", machine: "naira", durationMinutes: 60 },

  // --- Decoração Simples ---
  { category: "Decoração Simples", name: "Nail Art", price: "2€", machine: "naira", durationMinutes: 10 },
  { category: "Decoração Simples", name: "Adesivos / Gliter / Pedraria", price: "1€", machine: "naira", durationMinutes: 10 },
  { category: "Decoração Simples", name: "Nails com Styling Elaborado", price: "5€", machine: "naira", durationMinutes: 15 },

  // --- Manicure e Pedicure ---
  { category: "Cuidados", name: "Manicure", price: "8€", machine: "naira", durationMinutes: 30 },
  { category: "Cuidados", name: "Pedicure", price: "17€", machine: "naira", durationMinutes: 45 }
],

      PERFECT_HAIR_TECH: [
  // --- Lavagem e Tratamentos ---
  { name: "Só Lavagem de Cabelo (incluído shampoo e amaciador calha)", price: "4€", machine: "naira", durationMinutes: 100 },
  { name: "Shampoo Especial", price: "3€", machine: "naira", durationMinutes: 100 },
  { name: "Condicionador Especial", price: "2.5€", machine: "naira", durationMinutes: 100 },
  { name: "Máscara Argan", price: "6.5€", machine: "naira", durationMinutes: 100 },
  { name: "Máscara Hidratante", price: "4.5€", machine: "naira", durationMinutes: 100 },

  // --- Corte ---
  { name: "Corte Simples", price: "10€", machine: "naira", durationMinutes: 30 },

  // --- Coloração ---
  { name: "Coloração Curto", price: "25€", machine: "naira", durationMinutes: 60 },
  { name: "Coloração Médio", price: "30€", machine: "naira", durationMinutes: 60 },
  { name: "Coloração Longo", price: "35€", machine: "naira", durationMinutes: 75 },
  { name: "Coloração Extra Longo", price: "40€", machine: "naira", durationMinutes: 90 },
  { name: "Coloração Raízes", price: "30€", machine: "naira", durationMinutes: 60 },
  { name: "Matização / Tonalização", price: "25€", machine: "naira", durationMinutes: 60 },
  { name: "Madeixas / Nuances / Californianas", price: "a partir de 40€", machine: "naira", durationMinutes: 90 },

  // --- Descoloração ---
  { name: "Descoloração Total (Longo)", price: "60€", machine: "naira", durationMinutes: 75 },
  { name: "Descoloração Total (Curto/Médio)", price: "40€", machine: "naira", durationMinutes: 60 },
  { name: "Descoloração Raízes", price: "25€", machine: "naira", durationMinutes: 45 },

  // --- Brushing / Escova ---
  { name: "Brushing / Escova com Chapinha Curto", price: "8€", machine: "naira", durationMinutes: 30 },
  { name: "Brushing / Escova com Chapinha Médio", price: "12€", machine: "naira", durationMinutes: 45 },
  { name: "Brushing / Escova com Chapinha Longo", price: "12€", machine: "naira", durationMinutes: 45 },
  { name: "Brushing / Escova com Chapinha Extra Longo", price: "20€", machine: "naira", durationMinutes: 60 },

  // --- Ondulação ---
  { name: "Ondulação Curto", price: "35€", machine: "naira", durationMinutes: 45 },
  { name: "Ondulação Médio", price: "45€", machine: "naira", durationMinutes: 45 },
  { name: "Ondulação Longo", price: "60€", machine: "naira", durationMinutes: 45 },
  { name: "Ondulação Extra Longo", price: "80€", machine: "naira", durationMinutes: 45 },

  // --- Alisamento / Progressiva ---
  { name: "Alisamento / Progressiva Curto", price: "50€", machine: "naira", durationMinutes: 90 },
  { name: "Alisamento / Progressiva Médio", price: "100€", machine: "naira", durationMinutes: 90 },
  { name: "Alisamento / Progressiva Longo", price: "150€", machine: "naira", durationMinutes: 90 }
],

    };

    const SERVICES_BRAGA = {
      FACE_DESIGN_TECH: [
        { name: "Embelezamento Facial e Design Personalizado", durationMinutes:60 },
        { name: "Preenchimento Labial, Hy Aluron Pen", price: "150€", machine: "hyaluron-pen-lip-braga", durationMinutes:30 },
        { name: "Micropigmentação Labial", price: "180€", machine: "micropigment-lip-braga", durationMinutes:45 },
        { name: "Técnica Híbrida de Sobrancelhas", price: "180€", machine: "hybrid-brow-braga", durationMinutes:60 },
        { name: "Lash & Brow Lamination", price: "60€", machine: "lash-brow-lamination-braga", durationMinutes:45 },
        { name: "Extensão de Pestanas", price: "35€", machine: "eyelash-ext-braga", durationMinutes:60 },
        { name: "Design de Sobrancelhas & Henna", price: "25€", machine: "brow-henna-braga", durationMinutes:30 }
      ],
      PERFECT_FACE_TECH: [
        { name: "HIFU 12D — Rosto Completo", price: "200€", machine: "HIFU12D", durationMinutes:90 },
        { name: "HIFU 12D Rosto + Papada", price: "300€", machine: "HIFU12D", durationMinutes:100 },
        { name: "HIFU 12D Papada", price: "120€", machine: "HIFU12D", durationMinutes:45 },
        { name: "HIFU 12D", price: "70€", machine: "HIFU12D", durationMinutes:30 },
        { name: "HIFU 12D Rosto + Papada + Pescoço", price: "360€", machine: "HIFU12D", durationMinutes:120 },
        { name: " HIFU 12D Pure Facial", price: "60€", machine: "HIFU12D", durationMinutes:30 },
        { name: "Aplicação de Fios de Seda", price: "60€", machine: "silk-threads-braga", durationMinutes:45 }
      ],
      PERFECT_BODY_TECH: [
        { name: "Drenagem Linfática Manual", price: "40€", machine: "lymph-drainage-braga", durationMinutes:45 },
        { name: "Massagem Desportiva Localizada", price: "15€", machine: "sport-massage-braga", durationMinutes:30 },
        { name: "Massagem Modeladora e Redutora", price: "35€", machine: "modeling-massage-braga", durationMinutes:45 },
        { name: "Massagem Turbinada", price: "40€", machine: "turbo-massage-braga", durationMinutes:45 },
        { name: "Pressoterapia", price: "20€", machine: "pressotherapy-braga", durationMinutes:30 },
        { name: "Manta Térmica", price: "20€", machine: "thermal-blanket-braga", durationMinutes:20 },
        { name: "Máquina Detox Pés", price: "20€", machine: "foot-detox-machine-braga", durationMinutes:20 },
        { name: "HIFU 12D — Costas", price: "500€", machine: "HIFU12D", durationMinutes:120 },
        { name: "HIFU 12D — Barriga", price: "230€", machine: "HIFU12D", durationMinutes:120 },
        { name: "HIFU 12D — Glúteos", price: "200€", machine: "hifu-glutes-braga", durationMinutes:90 }
      ]
    };

   
  function servicesForBranch(branch){
    if(branch==='braga') return SERVICES_BRAGA;
    if(branch==='amora') return SERVICES_AMORA;
    return {};
  }

  const HOURS_BY_BRANCH = {
    amora: ["09:30","10:00","10:30","11:00","11:30","12:00","12:30","13:00","13:30","14:00","14:30","15:00","15:30","16:00","16:30","17:00","17:30"],
    braga: ["10:00","10:30","11:00","11:30","12:00","12:30","13:00","13:30","14:00","14:30","15:00","15:30","16:00","16:30","17:00","17:30","18:00","18:30","19:00","19:30","20:00","20:30","21:00","21:30","22:00"]
  };
  const DEFAULT_HOURS = ["09:00","09:30","10:00","10:30","11:00","11:30","12:00","12:30","13:00","13:30","14:00","14:30","15:00","15:30","16:00","16:30","17:00","17:30"];
  function getHoursForBranch(branch){ if(!branch) return DEFAULT_HOURS; return HOURS_BY_BRANCH[branch] || DEFAULT_HOURS; }

  // ------------------------------
  // NEW: scheduling helpers (added)
  // ------------------------------
  function parseTimeToMinutes(t){ if(!t) return 0; const parts = String(t).split(':').map(Number); return (parts[0]||0)*60 + (parts[1]||0); }
  function computeSlotIntervalMinutes(hours){ if(!hours||hours.length<2) return 30; const a=parseTimeToMinutes(hours[0]); const b=parseTimeToMinutes(hours[1]); const diff = Math.abs(b-a); return diff || 30; }
  function slotsNeededForDuration(durationMinutes, slotInterval){ return Math.max(1, Math.ceil((Number(durationMinutes)||30) / slotInterval)); }

  // expand an unavailable set by padding slots (both sides)
  function expandUnavailableSet(unavailableArr, slotOrder, paddingSlots){
    const idxMap = new Map(slotOrder.map((t,i)=>[t,i]));
    const base = new Set((unavailableArr||[]).map(String));
    const extra = new Set();
    base.forEach(t => {
      const idx = idxMap.get(String(t));
      if(typeof idx === 'undefined') return;
      for(let p=1;p<=paddingSlots;p++){
        const i1 = idx - p; const i2 = idx + p;
        if(i1>=0) extra.add(slotOrder[i1]);
        if(i2 < slotOrder.length) extra.add(slotOrder[i2]);
      }
    });
    return [...new Set([...base, ...extra])];
  }

  // ensure a start time has enough consecutive free slots for the service
  function isStartSlotValid(startTime, neededSlots, unavailableSet, slotOrder){
    const idx = slotOrder.indexOf(startTime);
    if(idx === -1) return false;
    for(let k=0;k<neededSlots;k++){
      const t = slotOrder[idx+k];
      if(!t) return false; // out of work hours
      if(unavailableSet.has(t)) return false;
    }
    return true;
  }

  // ------------------------------
  // state
  // ------------------------------
  let selectedBranch = null;
  let isOldClient = false;
  let clientData = {};
  let selectedCategoryKey = null;
  // NOTE: store duration/padding for each selected service when adding
  let selectedServices = []; // {category,name,price,machine,durationMinutes,paddingMinutes}
  let perServiceSelections = []; // {date, hour}
  let pikadayInstances = {}; // idx => pikaday

  // min days ahead for datepicker
  const MIN_DAYS_AHEAD = 3;
  function getMinDate(){ const d=new Date(); d.setHours(0,0,0,0); d.setDate(d.getDate()+MIN_DAYS_AHEAD); return d; }

  // ------------------------------
  // DOM refs
  // ------------------------------
  const branchRadios = document.querySelectorAll('input[name="branch"]');
  const clientTypeRadios = document.querySelectorAll('input[name="clientType"]');
  const clientNextBtn = document.getElementById('clientNextBtn');
  const oldCodeBox = document.getElementById('oldCodeBox');
  const newClientBox = document.getElementById('newClientBox');
  const validateCodeBtn = document.getElementById('validateCodeBtn');
  const clientCodeInput = document.getElementById('clientCode');
  const codeMsg = document.getElementById('codeMsg');
  const newClientNext = document.getElementById('newClientNext');
  const backToClientType1 = document.getElementById('backToClientType1');
  const backToClientType2 = document.getElementById('backToClientType2');

  const categoriesWrap = document.getElementById('categories');
  const servicesList = document.getElementById('servicesList');
  const selectedListEl = document.getElementById('selectedList');
  const countSelected = document.getElementById('countSelected');
  const totalPriceEl = document.getElementById('totalPrice');
  const summaryClient = document.getElementById('summaryClient');

  const backToStep1From2 = document.getElementById('backToStep1From2');
  const toCalendarBtn = document.getElementById('toCalendarBtn');
  const backToStep2 = document.getElementById('backToStep2');
  const confirmBtn = document.getElementById('confirmBtn');

  const servicePickersWrap = document.getElementById('servicePickersWrap');
  const voucherEl = document.getElementById('voucher'); // may be null
  const calendarMsg = document.getElementById('calendarMsg');

  const resumoBox = document.getElementById('resumoBox');
  const stepBlocks = {1:document.getElementById('step-1'),2:document.getElementById('step-2'),3:document.getElementById('step-3'),4:document.getElementById('step-4')};
  const stepLabels = {1:document.getElementById('stepLabel-1'),2:document.getElementById('stepLabel-2'),3:document.getElementById('stepLabel-3'),4:document.getElementById('stepLabel-4')};

  function showStep(n){
    Object.values(stepBlocks).forEach(el=>el.classList.add('hidden'));
    stepBlocks[n].classList.remove('hidden');
    Object.values(stepLabels).forEach(l=>l.classList.remove('active'));
    stepLabels[n].classList.add('active');
    window.scrollTo({top:0,behavior:'smooth'});
  }
  function enableClientNext(){
    const branchSelected = !!document.querySelector('input[name="branch"]:checked');
    const clientTypeSelected = !!document.querySelector('input[name="clientType"]:checked');
    clientNextBtn.disabled = !(branchSelected && clientTypeSelected);
    clientNextBtn.setAttribute('aria-disabled', String(clientNextBtn.disabled));
  }
  function setSummaryClientText(){
    if(isOldClient && clientData.name) summaryClient.textContent = `${clientData.name} (Cliente) — código: ${clientData.code || '—'}`;
    else { const name = document.getElementById('name')?.value || 'Cliente novo'; const phone = document.getElementById('phone')?.value || ''; summaryClient.textContent = `${name} ${phone? '• '+phone: ''}`; }
  }
  function calcTotal(){ let total=0; selectedServices.forEach(s=>{ if(!s.price) return; const m=String(s.price).match(/(\d+([.,]\d+)?)/); if(m){ const val=Number(String(m[1]).replace(',','.')); if(!isNaN(val)) total+=val; } }); totalPriceEl.textContent = total? total.toFixed(2).replace('.',',')+'€' : '0€'; }

  function showResumo(){ if(resumoBox) resumoBox.style.display = ''; }
  function hideResumoAndClear(){
    if(resumoBox) resumoBox.style.display = 'none';
    selectedServices = [];
    perServiceSelections = [];
    Object.keys(pikadayInstances || {}).forEach(k=>{ try{ pikadayInstances[k].destroy(); }catch(e){} });
    pikadayInstances = {};
    if(selectedListEl) selectedListEl.innerHTML = '';
    if(servicePickersWrap) servicePickersWrap.innerHTML = '';
    if(totalPriceEl) totalPriceEl.textContent = '0€';
    if(countSelected) countSelected.textContent = '0';
    if(confirmBtn) { confirmBtn.disabled = true; confirmBtn.setAttribute('aria-disabled','true'); }
  }

  function initCategories(){
    categoriesWrap.innerHTML = '';
    if(!selectedBranch){ categoriesWrap.innerHTML = '<div class="muted">Escolha a filial primeiro.</div>'; servicesList.innerHTML = '<p class="muted">Selecione uma categoria para ver serviços...</p>'; return; }
    const S = servicesForBranch(selectedBranch); const keys = Object.keys(S);
    keys.forEach(k=>{
      const div=document.createElement('div');
      div.className='cat';
      div.textContent=CATEGORY_LABELS[k] || k.replace(/_/g,' ');
      div.dataset.key=k;
      div.addEventListener('click', ()=>{
        document.querySelectorAll('.cat').forEach(c=>c.classList.remove('active'));
        div.classList.add('active');
        selectedCategoryKey=k;
        renderServicesForCategory(k);
      });
      categoriesWrap.appendChild(div);
    });
    servicesList.innerHTML = '<p class="muted">Selecione uma categoria para ver serviços...</p>';
  }

  function renderServicesForCategory(key){
    servicesList.innerHTML='';
    const S = servicesForBranch(selectedBranch);
    const list = S[key] || [];

    const header = document.createElement('div');
    header.style.padding='10px 8px';
    header.style.marginBottom='8px';
    const title = document.createElement('h3');
    title.style.margin='0 0 6px 0';
    title.style.fontSize='16px';
    title.style.fontWeight='800';
    title.textContent = CATEGORY_LABELS[key] || key.replace(/_/g,' ');
    header.appendChild(title);
    if(CATEGORY_SUBHEADERS[key]){
      const sub = document.createElement('div');
      sub.style.fontSize='13px';
      sub.style.color='rgba(255,255,255,0.85)';
      sub.style.marginTop='4px';
      sub.textContent = CATEGORY_SUBHEADERS[key];
      header.appendChild(sub);
    }
    servicesList.appendChild(header);

    if(!list.length){ const p=document.createElement('p'); p.className='muted'; p.textContent='Sem serviços nesta categoria.'; servicesList.appendChild(p); return; }

    list.forEach(svc=>{
      const row=document.createElement('div'); row.className='service-row';
      const left=document.createElement('div'); left.style.display='flex'; left.style.flexDirection='column';
      const nameEl=document.createElement('div'); nameEl.className='service-name'; nameEl.textContent = svc.name || svc.name;
      const catEl=document.createElement('div'); catEl.className='muted'; catEl.style.fontSize='12px'; catEl.textContent = CATEGORY_LABELS[key] || key.replace(/_/g,' ');
      left.appendChild(nameEl); left.appendChild(catEl);
      const right=document.createElement('div'); right.style.display='flex'; right.style.alignItems='center';
      const price=document.createElement('div'); price.className='service-price'; price.textContent = svc.price || '';
      const btn=document.createElement('button'); btn.className='add-btn'; btn.textContent='+';
      btn.addEventListener('click', ()=> addService(key, svc));
      right.appendChild(price); right.appendChild(btn);
      row.appendChild(left); row.appendChild(right);
      servicesList.appendChild(row);
    });
  }

  // ------------------------------
  // MODIFY: addService now stores durationMinutes & paddingMinutes (defaulted)
  // ------------------------------
  function addService(category, svc){
    const svcName = svc.name || svc.name;
    if(selectedServices.some(s=>s.name===svcName)){ flashServiceRow(svcName); return; }
    // Read duration/padding from svc if provided, otherwise defaults:
    const durationMinutes = typeof svc.durationMinutes !== 'undefined' ? svc.durationMinutes : 30;
    const paddingMinutes = typeof svc.paddingMinutes !== 'undefined' ? svc.paddingMinutes : 0;
    selectedServices.push({ category, name: svcName, price: svc.price || '', machine: svc.machine || null, durationMinutes, paddingMinutes });
    perServiceSelections = selectedServices.map((s,i)=> perServiceSelections[i] ? perServiceSelections[i] : {date:null,hour:null});
    renderSelectedList();
  }

  function removeServiceAt(idx){
    selectedServices.splice(idx,1);
    perServiceSelections.splice(idx,1);
    Object.keys(pikadayInstances).forEach(k=>{ try{ pikadayInstances[k].destroy(); }catch(e){} });
    pikadayInstances = {};
    renderSelectedList();
    if(!document.getElementById('step-3').classList.contains('hidden')){
      buildPerServicePickers();
    }
  }

  function renderSelectedList(){
    selectedListEl.innerHTML='';
    selectedServices.forEach((s, idx)=>{
      const li=document.createElement('li');
      const left=document.createElement('div'); left.style.maxWidth='70%';
      left.innerHTML=`<strong>${s.name}</strong><div style="font-size:12px;color:#ffdff4">${(CATEGORY_LABELS[s.category]||s.category).replace(/_/g,' ')}</div><div style="font-size:12px;color:rgba(255,255,255,0.75);margin-top:6px">Duração: ${s.durationMinutes || 30} min${s.paddingMinutes? ' • padding '+s.paddingMinutes+'min':''}</div>`;
      const right=document.createElement('div'); right.style.display='flex'; right.style.alignItems='center';
      const price=document.createElement('div'); price.style.marginRight='10px'; price.style.fontWeight='700'; price.style.color='#ffd6f6'; price.textContent=s.price||'';
      const rem=document.createElement('button'); rem.className='remove-small'; rem.textContent='Remover';
      rem.addEventListener('click', ()=> removeServiceAt(idx));
      right.appendChild(price); right.appendChild(rem);
      li.appendChild(left); li.appendChild(right);
      selectedListEl.appendChild(li);
    });
    countSelected.textContent = selectedServices.length;
    calcTotal();
    updateConfirmEnabled();
    if(selectedServices.length>0 || (clientData && (clientData.name || clientData.code))) showResumo();
  }

  function flashServiceRow(name){
    const rows = Array.from(document.querySelectorAll('.service-row'));
    const row = rows.find(r => r.textContent.includes(name));
    if(!row) return;
    row.style.boxShadow='inset 0 0 0 2px rgba(255,255,255,0.06)';
    setTimeout(()=> row.style.boxShadow='',360);
  }

  branchRadios.forEach(r=>r.addEventListener('change', (e)=>{ selectedBranch = e.target.value; initCategories(); enableClientNext(); }));
  clientTypeRadios.forEach(r=>r.addEventListener('change', enableClientNext));
  clientNextBtn.addEventListener('click', ()=>{
    const val=document.querySelector('input[name="clientType"]:checked')?.value;
    if(!val||!selectedBranch) return alert('Escolha a filial e tipo de cliente.');
    isOldClient = val==='old';
    if(isOldClient){ oldCodeBox.classList.remove('hidden'); newClientBox.classList.add('hidden'); }
    else { newClientBox.classList.remove('hidden'); oldCodeBox.classList.add('hidden'); }
  });

  backToClientType1.addEventListener('click', ()=>{
    oldCodeBox.classList.add('hidden');
    try { const el = document.querySelector('input[name="clientType"]:checked'); if(el) el.checked=false; } catch(e){}
    clientNextBtn.disabled = true;
    hideResumoAndClear();
  });
  backToClientType2.addEventListener('click', ()=>{ newClientBox.classList.add('hidden'); try { const el = document.querySelector('input[name="clientType"]:checked'); if(el) el.checked=false; } catch(e){} clientNextBtn.disabled=true; });

  validateCodeBtn.addEventListener('click', async ()=>{
    const code = clientCodeInput.value.trim();
    if(!code){ codeMsg.textContent='Insira o código.'; return; }
    codeMsg.textContent='Validando...';
    try {
      const res = await fetch(WEBHOOK_VALIDATE, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ code, branch: selectedBranch }) });
      const data = await res.json();
      if(data && data.success){
        clientData = data.client||{};
        clientData.code = code;
        codeMsg.textContent='Código válido. A seguir para serviços.';
        setSummaryClientText();
        showStep(2);
        showResumo();
      } else { codeMsg.textContent='Código inválido.'; }
    } catch(e){ console.error(e); codeMsg.textContent='Erro de rede ao validar.'; }
  });

  newClientNext.addEventListener('click', ()=>{
    const name=document.getElementById('name').value.trim();
    const email=document.getElementById('email').value.trim();
    const phone=document.getElementById('phone').value.trim();
    const birth=document.getElementById('birth').value;
    if(!selectedBranch){ alert('Escolha a filial antes de continuar.'); return; }
    if(!name||!email||!phone||!birth){ alert('Preencha todos os campos.'); return; }
    clientData = { name, email, phone, birth, favService: document.getElementById('favService').value, code: 'VIP-'+Math.floor(100000+Math.random()*900000) };
    setSummaryClientText(); initCategories(); showStep(2);
    showResumo();
  });

  backToStep1From2.addEventListener('click', ()=> showStep(1));
  toCalendarBtn.addEventListener('click', ()=>{
    if(!selectedBranch){ alert('Escolha a filial.'); showStep(1); return; }
    if(selectedServices.length===0){ if(!confirm('Nenhum serviço selecionado. Deseja continuar?')) return; }
    buildPerServicePickers(); showStep(3);
  });

  document.getElementById('backToStep2').addEventListener('click', ()=> showStep(2));
  document.getElementById('backToStep3').addEventListener('click', ()=> showStep(3));
  document.getElementById('backToStep1From2').addEventListener('click', ()=> showStep(1));

  // ------------------------------
  // CONFIG + helpers: minimal changes required by your request
  // ------------------------------
  // You can edit SERVICE_DATE_RULES to match which branches/machines should have restricted dates.
  const SERVICE_DATE_RULES = {
    amora: {
      machines: {
        // machine name keys should match svc.machine values (case-sensitive)
        HIFU12D: { type: 'lastWeekend' },Helena: { type: 'lastWeekend' },
        Laser: { type: 'lastWeekend' }
      },
      default: { type: 'always' }
    },
    // add more branches here if needed, e.g.:
    // braga: { machines: { specialMachine: { type: 'specificDates', dates: ['2025-11-10'] } }, default: { type:'always' } }
  };
  // branch-level closed weekdays (0=Sun, 1=Mon, ..., 6=Sat)
// Example: amora closed on Mondays
const BRANCH_CLOSED_WEEKDAYS = {
  amora: [1], // Monday closed
  // braga: [0], // نمونه: اگر بخوای یک شعبه یکشنبه رو ببنده
};


  // helper: format date to YYYY-MM-DD
  function formatYMD(d){
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  }
  function lastWeekdayOfMonth(year, monthZeroBased, weekday){
    const dt = new Date(year, monthZeroBased + 1, 0);
    while(dt.getDay() !== weekday){
      dt.setDate(dt.getDate() - 1);
    }
    return new Date(dt.getFullYear(), dt.getMonth(), dt.getDate());
  }
  function isLastWeekendOfMonth(date){
    if(!date || !(date instanceof Date)) return false;
    const day = date.getDay();
    if(day !== 5 && day !== 6) return false;
    const y = date.getFullYear(), m = date.getMonth();
    const lastFri = lastWeekdayOfMonth(y, m, 5);
    const lastSat = lastWeekdayOfMonth(y, m, 6);
    const ds = formatYMD(date);
    return ds === formatYMD(lastFri) || ds === formatYMD(lastSat);
  }

  function isDateAllowedForService(date, svc){
  if(!date || !(date instanceof Date)) return false;
  // respect minDate
  if(typeof getMinDate === 'function'){
    const min = getMinDate();
    const minNorm = new Date(min.getFullYear(), min.getMonth(), min.getDate());
    const dateNorm = new Date(date.getFullYear(), date.getMonth(), date.getDate());
    if(dateNorm < minNorm) return false;
  }

  // --------------- NEW: branch-level closed weekdays ---------------
  const closed = BRANCH_CLOSED_WEEKDAYS && BRANCH_CLOSED_WEEKDAYS[selectedBranch];
  if(Array.isArray(closed) && closed.includes(date.getDay())){
    // this weekday is closed for the entire branch -> not allowed for any service
    return false;
  }
  // ----------------------------------------------------------------

  const branchRules = SERVICE_DATE_RULES[selectedBranch];
  if(!branchRules) return true;

  const machine = svc && svc.machine ? String(svc.machine) : null;
  let rule = null;
  if(machine && branchRules.machines && branchRules.machines[machine]){
    rule = branchRules.machines[machine];
  } else if(branchRules.default){
    rule = branchRules.default;
  } else {
    rule = { type: 'always' };
  }

  if(rule.type === 'always') return true;
  if(rule.type === 'lastWeekend') return isLastWeekendOfMonth(date);
  if(rule.type === 'weekdays' && Array.isArray(rule.days)) return rule.days.includes(date.getDay());
  if(rule.type === 'specificDates' && Array.isArray(rule.dates)){
    const ds = formatYMD(date);
    return rule.dates.includes(ds);
  }
  return true;
  }
  // ------------------------------

  // ------------------------------
  // buildPerServicePickers (unchanged API but uses new helpers)
  // ------------------------------
  function buildPerServicePickers(){
    const oldSelections = perServiceSelections.slice();
    perServiceSelections = selectedServices.map((s,i)=> oldSelections[i] ? { date: oldSelections[i].date, hour: oldSelections[i].hour } : { date:null, hour:null });
    Object.keys(pikadayInstances).forEach(k=>{ try{ pikadayInstances[k].destroy(); }catch(e){} });
    pikadayInstances = {};
    servicePickersWrap.innerHTML = '';

    selectedServices.forEach((svc, idx)=>{
      const wrap = document.createElement('div'); wrap.className='service-picker'; wrap.dataset.idx = idx;
      const title = document.createElement('h4'); title.textContent = `${svc.name} — ${svc.price||''}`; wrap.appendChild(title);

      const dateLabel = document.createElement('label'); dateLabel.textContent = 'Escolha data'; wrap.appendChild(dateLabel);
      const dateInput = document.createElement('input'); dateInput.type='text'; dateInput.readOnly=true; dateInput.placeholder='Clique para selecionar a data'; dateInput.id = `svc-date-${idx}`; dateInput.style.marginTop='6px'; wrap.appendChild(dateInput);

      const slotsDiv = document.createElement('div'); slotsDiv.className='slots'; slotsDiv.id = `svc-slots-${idx}`; slotsDiv.style.marginTop='10px'; wrap.appendChild(slotsDiv);

      const chosenDiv = document.createElement('div'); chosenDiv.id = `svc-chosen-${idx}`; chosenDiv.style.marginTop='8px'; chosenDiv.className='muted';
      const sel = perServiceSelections[idx];
      chosenDiv.textContent = sel && sel.date && sel.hour ? `Data: ${sel.date} — Hora: ${sel.hour}` : (sel && sel.date ? `Data: ${sel.date} — seleccione hora` : 'Nenhuma data/hora selecionada.');
      wrap.appendChild(chosenDiv);

      servicePickersWrap.appendChild(wrap);

      const pik = new Pikaday({
        field: dateInput,
        format: 'YYYY-MM-DD',
        minDate: getMinDate(),
        // disableDayFn: return true to DISABLE a date
        disableDayFn: function(date){
          try {
            return !isDateAllowedForService(date, svc);
          } catch(e){
            console.error('disableDayFn error', e);
            return false;
          }
        },
        onSelect: function(date){
          const yyyy = date.getFullYear(); const mm = String(date.getMonth()+1).padStart(2,'0'); const dd = String(date.getDate()).padStart(2,'0');
          const selDate = `${yyyy}-${mm}-${dd}`;
          perServiceSelections[idx].date = selDate;
          perServiceSelections[idx].hour = null;
          document.getElementById(`svc-chosen-${idx}`).textContent = `Data: ${selDate} — seleccione hora`;
          fetchAvailableSlotsForService(selDate, idx);
          updateConfirmEnabled();
        }
      });
      pikadayInstances[idx] = pik;

      // clear any previously chosen date if now invalid under the rules
      if(perServiceSelections[idx] && perServiceSelections[idx].date){
        const preDate = new Date(perServiceSelections[idx].date + 'T00:00:00');
        if(!isDateAllowedForService(preDate, svc)){
          perServiceSelections[idx].date = null;
          perServiceSelections[idx].hour = null;
          dateInput.value = '';
          document.getElementById(`svc-chosen-${idx}`).textContent = 'Nenhuma data/hora selecionada.';
        }
      }

      if(perServiceSelections[idx] && perServiceSelections[idx].date){
        dateInput.value = perServiceSelections[idx].date;
        // fetch and render existing selection
        fetchAvailableSlotsForService(perServiceSelections[idx].date, idx).then(()=>{ updateConfirmEnabled(); });
      } else {
        renderTimeSlotsForService(idx, []);
      }
    });

    updateConfirmEnabled();
  }

  // ------------------------------
  // renderTimeSlotsForService now considers needed consecutive slots
  // ------------------------------
  function renderTimeSlotsForService(idx, unavailable=[]){
    const slotsEl = document.getElementById(`svc-slots-${idx}`); if(!slotsEl) return;
    slotsEl.innerHTML = '';
    const setUnavailable = new Set((unavailable||[]).map(String));
    perServiceSelections[idx].hour = perServiceSelections[idx].hour && !setUnavailable.has(perServiceSelections[idx].hour) ? perServiceSelections[idx].hour : null;

    const HOURS = getHoursForBranch(selectedBranch);
    const slotOrder = HOURS;
    const slotInterval = computeSlotIntervalMinutes(slotOrder);
    const svc = selectedServices[idx] || { durationMinutes:30, paddingMinutes:0 };
    const neededSlots = slotsNeededForDuration(svc.durationMinutes || 30, slotInterval);

    // If service has paddingMinutes, we've already expanded unavailable before calling this
    // (fetchAvailableSlotsForService does expansion). But just in case, we won't re-expand here.

    HOURS.forEach(h=>{
      const btn = document.createElement('button'); btn.type='button'; btn.className='slot-button'; btn.textContent=h;
      const canStart = isStartSlotValid(h, neededSlots, setUnavailable, slotOrder);
      if(!canStart){ btn.disabled=true; btn.title='Indisponível ou não há slots consecutivos suficientes'; btn.style.opacity=0.45; }
      else {
        btn.addEventListener('click', ()=>{
          slotsEl.querySelectorAll('.slot-button').forEach(b=>b.classList.remove('selected'));
          btn.classList.add('selected');
          perServiceSelections[idx].hour = h;
          document.getElementById(`svc-chosen-${idx}`).textContent = `Data: ${perServiceSelections[idx].date} — Hora: ${h}`;
          updateConfirmEnabled();
        });
      }
      slotsEl.appendChild(btn);
    });

    const prev = perServiceSelections[idx].hour;
    if(prev){
      const buttonToSelect = Array.from(slotsEl.querySelectorAll('.slot-button')).find(b => b.textContent === prev && !b.disabled);
      if(buttonToSelect){ buttonToSelect.classList.add('selected'); document.getElementById(`svc-chosen-${idx}`).textContent = `Data: ${perServiceSelections[idx].date} — Hora: ${prev}`; }
      else { perServiceSelections[idx].hour=null; document.getElementById(`svc-chosen-${idx}`).textContent = `Data: ${perServiceSelections[idx].date} — seleccione hora`; }
    }
  }

  function normalizeUnavailable(data){
    if(!data) return [];
    let arr = [];
    if(Array.isArray(data.unavailableHours)) arr.push(...data.unavailableHours);
    if(Array.isArray(data.unavailable)) arr.push(...data.unavailable);
    if(Array.isArray(data) && data.length && typeof data[0] === 'string') arr.push(...data);
    if(typeof data === 'object' && data !== null){
      for(const k of Object.keys(data)){
        const v = data[k];
        if(typeof v === 'string') arr.push(v);
        else if(Array.isArray(v)) arr.push(...v.map(x=>String(x)));
      }
    }
    const splitItems = arr.flatMap(item => String(item).split(',').map(x=>x.trim().replace(/,$/,'')).filter(Boolean));
    const unique = [...new Set(splitItems)];
    const branchHours = getHoursForBranch(selectedBranch);
    const ordered = branchHours.filter(h => unique.includes(h));
    const extras = unique.filter(u => !branchHours.includes(u));
    return [...ordered, ...extras];
  }

  // ------------------------------
  // fetchAvailableSlotsForService: now sends duration/padding and expands unavailable locally
  // ------------------------------
  async function fetchAvailableSlotsForService(date, serviceIdx){
    if(!date) return;
    if(typeof serviceIdx === 'undefined' || !selectedServices[serviceIdx]){ console.error('serviceIdx inválido', serviceIdx); return; }
    const svc = selectedServices[serviceIdx];
    calendarMsg.textContent = `Verificando horários para "${svc.name}"...`;
    const payload = { date, service: { name: svc.name, category: svc.category, price: svc.price, machine: svc.machine || null, durationMinutes: svc.durationMinutes || 30, paddingMinutes: svc.paddingMinutes || 0 }, branch: selectedBranch };
    const webhook = selectedBranch === 'braga' ? WEBHOOK_AVAILABLE_BRAGA : WEBHOOK_AVAILABLE_AMORA;
    try {
      const res = await fetch(webhook, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      if(!res.ok){ calendarMsg.textContent = 'Erro ao consultar horários (status ' + res.status + ').'; renderTimeSlotsForService(serviceIdx, []); return; }
      let data;
      try { data = await res.json(); } catch(e){
        const txt = await res.text();
        try { data = JSON.parse(txt); } catch(err){ data = txt.includes(':') ? { unavailableHours: txt.split(',').map(s=>s.trim()).filter(Boolean) } : {}; }
      }
      let unavailable = normalizeUnavailable(data);
      // local expansion using padding (so UI blocks surrounding slots if padding requested)
      const slotOrder = getHoursForBranch(selectedBranch);
      const slotInterval = computeSlotIntervalMinutes(slotOrder);
      const paddingSlots = Math.max(0, Math.ceil((svc.paddingMinutes||0)/slotInterval));
      if(paddingSlots > 0){
        unavailable = expandUnavailableSet(unavailable, slotOrder, paddingSlots);
      }
      renderTimeSlotsForService(serviceIdx, unavailable);
      calendarMsg.textContent = '';
    } catch(e){ console.error(e); calendarMsg.textContent = 'Erro de conexão — verifique CORS / webhook.'; renderTimeSlotsForService(serviceIdx, []); }
  }

  function updateConfirmEnabled(){
    if(selectedServices.length === 0){ confirmBtn.disabled = false; confirmBtn.setAttribute('aria-disabled','false'); return; }
    const allSelected = perServiceSelections.length === selectedServices.length && perServiceSelections.every(s => s.date && s.hour);
    confirmBtn.disabled = !allSelected;
    confirmBtn.setAttribute('aria-disabled', String(confirmBtn.disabled));
  }

  // ------------------------------
  // confirm/reserve: build occupiedSlots per service and send them
  // ------------------------------
  confirmBtn.addEventListener('click', async ()=>{
    if(selectedServices.length>0){
      const incomplete = perServiceSelections.some(s=>!s.date || !s.hour);
      if(incomplete){ alert('Por favor selecione data e hora para todos os serviços.'); return; }
    } else { alert('Nenhum serviço selecionado — procedendo sem serviços.'); }

    // Build services payload with precise occupied slots (use slotInterval to generate consecutive times)
    const slotOrder = getHoursForBranch(selectedBranch);
    const slotInterval = computeSlotIntervalMinutes(slotOrder);
 
    const params = new URLSearchParams(window.location.search);
  let ref = params.get("ref") || localStorage.getItem("refCode");
  if (ref) {
    const refField = document.getElementById("refField");
    if (refField) refField.value = ref;
  }

    const servicesPayload = selectedServices.map((s, idx)=>{
      const start = perServiceSelections[idx]?.hour || null;
      const date = perServiceSelections[idx]?.date || null;
      const neededSlots = slotsNeededForDuration(s.durationMinutes||30, slotInterval);
      const startIndex = slotOrder.indexOf(start);
      const occupiedSlots = [];
      for(let k=0;k<neededSlots;k++){
        const t = slotOrder[startIndex + k];
        if(t) occupiedSlots.push(t);
      }
      return {
        name: s.name,
        category: s.category,
        price: s.price,
        machine: s.machine || null,
        date,
        startHour: start,
        durationMinutes: s.durationMinutes || 30,
        paddingMinutes: s.paddingMinutes || 0,
        occupiedSlots ,// list of time strings that should be marked blocked in external systems
        ref
      };
    });

    const payload = {
      client: clientData,
      services: servicesPayload,
      voucher: voucherEl ? voucherEl.value.trim() : '',
      branch: selectedBranch,
      oldClient: isOldClient,
      ref
    };

    const webhook = selectedBranch === 'braga' ? WEBHOOK_RESERVE_BRAGA : WEBHOOK_RESERVE_AMORA;
    calendarMsg.textContent = 'Enviando reserva...';

    try {
      await fetch(webhook, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });

      if(resumoBox) resumoBox.style.display = 'none';
      const serviceNames = selectedServices.map(s => s.name).join(', ');
      document.getElementById('finalMsg').textContent = `✅ Reserva confirmada para: ${serviceNames}. Você receberá confirmação por e-mail/SMS.`;
      showStep(4);
      calendarMsg.textContent = '';
    } catch(e){
      console.error(e);
      calendarMsg.textContent = 'Erro ao enviar reserva. Tente novamente mais tarde.';
    }
  });

  document.getElementById('finishBtn').addEventListener('click', ()=>{
    hideResumoAndClear();
    selectedBranch=null; isOldClient=false; clientData={}; selectedCategoryKey=null;
    perServiceSelections=[]; Object.keys(pikadayInstances).forEach(k=>{ try{ pikadayInstances[k].destroy(); }catch(e){} });
    pikadayInstances={}; document.querySelectorAll('input[name="branch"]').forEach(i=>i.checked=false); document.querySelectorAll('input[name="clientType"]').forEach(i=>i.checked=false);
    document.getElementById('clientCode').value=''; document.getElementById('codeMsg').textContent=''; document.getElementById('name').value=''; document.getElementById('email').value=''; document.getElementById('phone').value=''; document.getElementById('birth').value='';
    if(voucherEl) voucherEl.value=''; renderSelectedList(); setSummaryClientText(); showStep(1); initCategories(); oldCodeBox.classList.add('hidden'); newClientBox.classList.add('hidden'); calendarMsg.textContent='';
  });

  function bootstrap(){ initCategories(); renderSelectedList(); showStep(1); confirmBtn.disabled=true; }
  bootstrap();

})();
</script>
<script>
  (function() {
    try {
      // ref را از URL بگیر
      const params = new URLSearchParams(window.location.search);
      const ref = params.get("ref");
  
      // اگر وجود داشت، ذخیره کن
      if (ref) {
        console.log("🔹 Ref detected in URL:", ref);
        localStorage.setItem("refCode", ref);
      } else {
        console.log("ℹ️ No ref in URL. Using saved value:", localStorage.getItem("refCode"));
      }
  
      // اگر هنوز در لینک‌ها نبود، اضافه کن
      const savedRef = localStorage.getItem("refCode");
      if (savedRef) {
        document.querySelectorAll("a[href]").forEach(link => {
          try {
            const href = link.getAttribute("href");
            if (!href || href.startsWith("javascript:") || href.startsWith("#")) return;
            const url = new URL(href, window.location.origin);
            if (!url.searchParams.has("ref")) {
              url.searchParams.set("ref", savedRef);
              link.href = url.toString();
            }
          } catch(e){}
        });
      }
  
      // جلوگیری از ارورهای اسکریپت‌های دیگه (مثلاً slider)
      window.addEventListener("error", e => {
        console.warn("⚠️ JS error ignored:", e.message);
        e.preventDefault();
      });
  
    } catch (err) {
      console.error("Ref handler error:", err);
    }
  })();
  </script>
  
</body>
</html>
