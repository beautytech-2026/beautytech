<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reserva de Horário</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pikaday/css/pikaday.css" />
  <style>
    body {
      background: linear-gradient(to bottom right, #dd0583, #8e2de2);
      font-family: 'Vazirmatn', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 30px;
      overflow-x: hidden;
      position: relative;
      color: white;
    }
    .container {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 30px;
      max-width: 440px;
      width: 100%;
      box-shadow: 0 0 20px #e178f4;
    }
    h2 {
      text-align: center;
      margin-bottom: 25px;
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: bold;
    }
    input, button, select {
      width: 100%;
      padding: 10px;
      margin-bottom: 16px;
      border-radius: 8px;
      border: none;
      font-size: 15px;
    }
    input, select {
      background: rgba(255, 255, 255, 0.2);
      color: #c13a8f;
    }
    button {
      background: #c02190;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    .slot-button {
      display: inline-block;
      padding: 8px 12px;
      border-radius: 6px;
      margin: 5px 5px 10px 0;
      background: #fff;
      color: #ae6de8;
      cursor: pointer;
      border: none;
    }
    .slot-button.selected {
      background: #d81e6f;
      color: white;
    }
    .back-button {
      position: fixed;
      top: 20px;
      left: 20px;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(6px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
      transition: background 0.3s ease;
    }
    .back-button:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    .back-button svg {
      width: 24px;
      height: 24px;
      stroke: white;
    }
  </style>
</head>


<body>

  <a href="index.html" class="back-button" title="voltar">
    <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="10" />
      <polyline points="12 8 8 12 12 16" />
      <line x1="16" y1="12" x2="8" y2="12" />
    </svg>
  </a>




  <div class="container">
    <h2>Reserva de Horário</h2>

    <div id="step-client">
      <label>Você é cliente atual?</label><br />
      <label><input type="radio" name="clientType" value="old" /> Sim</label>
      <label><input type="radio" name="clientType" value="new" /> Não</label>
      <button id="clientTypeBtn" disabled>Continuar</button>
    </div>

    <div id="step-code" style="display:none;">
      <label for="clientCode">Código do Cliente:</label>
      <input type="text" id="clientCode" />
      <button onclick="validateCode()">Validar Código</button>
      <p id="codeMessage" style="color: #ff6666;"></p>
    </div>

    <form id="newClientForm" style="display:none;" onsubmit="return false;">
      <label>Nome:</label>
      <input type="text" id="name" required />
      <label>Email:</label>
      <input type="email" id="email" required />
      <label>Telefone:</label>
      <input type="text" id="phone" required />
      <label>Qual e o serviço que mais usa</label>
      <select id="nationality">
        <option>unhas</option>
        <option>cabelo</option>
        <option>estética corporal</option>
        <option>estética facial</option>
        <option>Outro</option>
      </select>
      <label>Data de Nascimento:</label>
      <input type="date" id="birth" required />
      <input type="hidden" id="vipCode" name="vipCode" />
      <button type="button" onclick="showCalendar()">Próximo</button>
    </form>

    <div id="calendarStep" style="display:none;">
      <label for="voucherCode">voucher code (se tem):</label>
      <input type="text" id="voucherCode" name="voucherCode" />
      <label>Escolha a data:</label>
      <input type="text" id="datepicker" readonly />
      <div id="slots"></div>
      <button id="confirmButton">Confirmar ou Pagar</button>
      <p id="message" style="color: #ff6666;"></p>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/pikaday/pikaday.js"></script>
  <script>
    // خواندن پارامترهای URL
    const urlParams = new URLSearchParams(window.location.search);
    const service = urlParams.get("service") || "";
    const ref = urlParams.get("ref") || ""; // ref که باید ارسال شود
    const voucherCode = document.getElementById("voucherCode");

    // آدرس وبهوک‌ها
    const webhookValidate = "https://hook.eu2.make.com/mgz53fgt82dhtfc4wnaiubjy7j5ajcjv";
    const webhookAvailable = "https://hook.eu2.make.com/sw48l9g8shmdh766arjpngluo7pk0ja6";
    const webhookReserveNewClient = "https://hook.eu2.make.com/lgeq95xbn4oyzg52fi9ambyccww1hgim";
    const webhookReserveOldClient = webhookReserveNewClient;

    const allHours = [
      "09:00", "10:00", "11:00", "12:00",
      "13:00", "14:00", "15:00", "16:00", "17:00"
    ];

    let isOldClient = false;
    let clientInfo = {};
    let selectedSlot = { date: null, hour: null };
    let pikadayInstance = null;

    // کنترل انتخاب نوع مشتری
    const clientTypeRadios = document.querySelectorAll('input[name="clientType"]');
    const clientTypeBtn = document.getElementById("clientTypeBtn");

    clientTypeRadios.forEach(radio => {
      radio.addEventListener('change', () => {
        clientTypeBtn.disabled = false;
      });
    });

    clientTypeBtn.addEventListener('click', () => {
      const selected = document.querySelector('input[name="clientType"]:checked').value;
      isOldClient = selected === "old";
      document.getElementById('step-client').style.display = 'none';

      const randomCode = "vip_" + Math.floor(100000 + Math.random() * 900000);
      document.getElementById("vipCode").value = randomCode;

      if (isOldClient) {
        document.getElementById('step-code').style.display = 'block';
      } else {
        document.getElementById('newClientForm').style.display = 'block';
      }
    });

    async function validateCode() {
      const code = document.getElementById('clientCode').value.trim();
      if (!code) {
        document.getElementById('codeMessage').textContent = "Por favor, insira o código.";
        return;
      }
      document.getElementById('codeMessage').textContent = "Validando...";
      try {
        const res = await fetch(webhookValidate, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ clientCode: code, ref })
        });
        const data = await res.json();
        if (data.isValid) {
          document.getElementById('codeMessage').style.color = "lime";
          document.getElementById('codeMessage').textContent = "Código válido! Agora escolha a data.";
          isOldClient = true;
          clientInfo.clientCode = code;
          document.getElementById('step-code').style.display = 'none';
          showCalendar();
        } else {
          document.getElementById('codeMessage').style.color = "#ff6666";
          document.getElementById('codeMessage').textContent = "Código inválido, tente novamente.";
        }
      } catch (e) {
        document.getElementById('codeMessage').style.color = "#ff6666";
        document.getElementById('codeMessage').textContent = "Erro ao validar o código.";
        console.error(e);
      }
    }

    // نمایش تقویم و تنظیم رویداد
    function showCalendar() {
      document.getElementById('newClientForm').style.display = 'none';
      document.getElementById('calendarStep').style.display = 'block';

      if (pikadayInstance) {
        pikadayInstance.destroy();
      }

      pikadayInstance = new Pikaday({
        field: document.getElementById('datepicker'),
        format: 'YYYY-MM-DD',
        minDate: new Date(),
        onSelect: function () {
          fetchAvailableSlots(this.toString("YYYY-MM-DD"));
        }
      });
    }

    async function fetchAvailableSlots(date) {
      selectedSlot.date = date;
      selectedSlot.hour = null;
      renderTimeSlots([]); // پاک کردن زمان‌های قبلی
      const vouchCode = document.getElementById('voucherCode').value.trim();

      try {
        const res = await fetch(webhookAvailable, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ date, service, ref, voucherCode: vouchCode })
        });
        const data = await res.json();
        const unavailable = data.unavailableHours || [];
        renderTimeSlots(unavailable);
      } catch (e) {
        console.error("Erro ao buscar horários disponíveis", e);
        renderTimeSlots();
      }
    }

    function renderTimeSlots(unavailable = []) {
      const container = document.getElementById("slots");
      container.innerHTML = "";
      allHours.forEach(hour => {
        const isUnavailable = unavailable.includes(hour);
        const btn = document.createElement("button");
        btn.textContent = hour;
        btn.classList.add("slot-button");
        if (isUnavailable) {
          btn.disabled = true;
          btn.style.opacity = "0.4";
        } else {
          btn.addEventListener("click", () => {
            selectedSlot.hour = hour;
            document.querySelectorAll(".slot-button").forEach(b => b.classList.remove("selected"));
            btn.classList.add("selected");
          });
        }
        container.appendChild(btn);
      });
    }

    document.getElementById("confirmButton").addEventListener("click", async () => {
      const vouchCode = document.getElementById('voucherCode').value.trim();

      if (!selectedSlot.date || !selectedSlot.hour) {
        showMessage("Por favor, selecione uma data e horário.");
        return;
      }

      if (isOldClient) {
        // ارسال رزرو مشتری قدیمی
        const payload = {
          clientCode: clientInfo.clientCode,
          service,

          date: selectedSlot.date,
          hour: selectedSlot.hour,
          ref,
          voucherCode: vouchCode


        };
        try {
          const res = await fetch(webhookReserveOldClient, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          const data = await res.json();
          if (data.paymentLink) {
            window.location.href = data.paymentLink;
          } else {
            showMessage("Erro ao processar reserva.");
          }
        } catch (e) {
          console.error(e);
          showMessage("Erro na comunicação com o servidor.");
        }
      } else {
        // ارسال رزرو مشتری جدید همراه با اطلاعات فرم
        const name = document.getElementById('name').value.trim();
        const email = document.getElementById('email').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const birth = document.getElementById('birth').value;
        const nationality = document.getElementById('nationality').value;
        const vipCode = document.getElementById('vipCode').value;

        if (!name || !email || !phone || !birth) {
          showMessage("Por favor, preencha todos os campos.");
          return;
        }

        const payload = {
          name,
          email,
          phone,
          birth,
          nationality,
          vipCode,
          service,
          date: selectedSlot.date,
          hour: selectedSlot.hour,
          ref,
          voucherCode: vouchCode
        };

        try {
          const res = await fetch(webhookReserveNewClient, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          const data = await res.json();
          if (data.paymentLink) {
            window.location.href = data.paymentLink;
          } else {
            showMessage("Erro ao processar reserva.");
          }
        } catch (e) {
          console.error(e);
          showMessage("Erro na comunicação com o servidor.");
        }
      }
    });

    function showMessage(msg) {
      const el = document.getElementById("message");
      el.textContent = msg;
      setTimeout(() => {
        el.textContent = "";
      }, 6000);
    }
  </script>


</body>

</html>
