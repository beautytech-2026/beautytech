<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reserva de Horário</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pikaday/css/pikaday.css">
  <style>
    body {
      background: linear-gradient(to bottom right, #dd0583, #8e2de2);
      font-family: 'Vazirmatn', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 30px;
      overflow-x: hidden;
      position: relative;
    }
    .container {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 30px;
      max-width: 640px;
      width: 100%;
      box-shadow: 0 0 20px #e178f4;
      color: white;
    }
    h2 { text-align: center; margin-bottom: 8px; }
    #serviceHeader { text-align:center; margin-bottom:18px; color:#fff; font-size:1.05rem; opacity:0.95; }
    label { display:block; margin-bottom:6px; font-weight:700; }
    input, button, select { width:100%; padding:10px; margin-bottom:16px; border-radius:8px; border:none; font-size:15px; }
    input, select { background: rgba(255,255,255,0.18); color:#c13a8f; }
    button { background:#c02190; color:white; font-weight:700; cursor:pointer; }
    .slot-button { display:inline-block; padding:8px 12px; border-radius:6px; margin:5px 5px 10px 0; background:#fff; color:#ae6de8; cursor:pointer; border:none; }
    .slot-button.selected { background:#d81e6f; color:white; }
    p.small { color:#999; font-size:0.9rem; text-align:center; }
  </style>
</head>
<body>
  <div id="menu-placeholder"></div>

  <script>
    // بارگذاری فایل منو (اگر داری)
    fetch("menuamora.html").then(res=>res.text()).then(html=>{
      const ph = document.getElementById("menu-placeholder");
      if(ph){ ph.innerHTML = html;
        // اجرا کردن اسکریپت‌های داخل menu اگر وجود داشت
        const scripts = ph.querySelectorAll("script");
        scripts.forEach(s=>{
          const ns = document.createElement("script");
          if(s.src) ns.src = s.src; else ns.textContent = s.textContent;
          document.body.appendChild(ns);
        });
      }
    }).catch(()=>{/* ignore if not present */});
  </script>

  <div class="container">
    <h2>Reserva de Horário</h2>

    <!-- NEW: service header (shows which service is being booked) -->
    <h3 id="serviceHeader">Selecione o serviço</h3>

    <!-- مرحله انتخاب مشتری قدیمی یا جدید با radio -->
    <div id="step-client">
      <label>Você é cliente atual?</label><br>
      <label><input type="radio" name="clientType" value="old"> Sim</label>
      <label><input type="radio" name="clientType" value="new"> Não</label>
      <button id="clientTypeBtn" disabled>Continuar</button>
    </div>

    <div id="step-code" style="display:none">
      <label for="clientCode">Código do Cliente:</label>
      <input type="text" id="clientCode">
      <button onclick="validateCode()">Validar Código</button>
      <p id="codeMessage" style="color: #ff6666;"></p>
    </div>

    <form id="newClientForm" style="display:none">
      <label>Nome:</label><input type="text" id="name" required>
      <label>Email:</label><input type="email" id="email" required>
      <label>Telefone:</label><input type="text" id="phone" required>
      <label>Qual e o serviço que mais usa</label>
      <select id="nationality">
        <option>unhas</option>
        <option>cabelo</option>
        <option>estética corporal </option>
        <option>estética facial</option>
        <option>Outro</option>
      </select>
      <label>Data de Nascimento:</label><input type="date" id="birth" required>
      <input type="hidden" id="vipCode" name="vipCode">
      <button type="button" onclick="showCalendar()">Próximo</button>
    </form>

    <div id="calendarStep" style="display:none">
      <label for="voucher">voucher code (se tem):</label>
      <input type="text" id="voucherCode" name="voucherCode" />
      <label>Escolha a data:</label>
      <input type="text" id="datepicker" readonly>
      <div id="slots" style="margin-top:12px;"></div>
      <button id="confirmButton">Confirmar ou Pagar</button>
      <p id="message" style="color: #ff6666;"></p>
    </div>
  </div>

  <p class="small">está na página de reservas da Beautytech de Amora</p>

  <div id="codeValidationResult" style="display:none; margin-top:20px; padding:15px; border-radius:10px; background:rgba(255,255,255,0.12); color:white; text-align:center;"></div>

  <script src="https://cdn.jsdelivr.net/npm/pikaday/pikaday.js"></script>
  <script>
    // read service param and show it in header
    const service = new URLSearchParams(window.location.search).get("service") || "";
    const ref = new URLSearchParams(window.location.search).get("ref") || "";

    const headerEl = document.getElementById('serviceHeader');

    function prettyServiceName(raw){
      if(!raw) return 'Selecione o serviço';
      // decode, replace +,_,- with spaces, trim
      try {
        raw = decodeURIComponent(raw);
      } catch(e){}
      return raw.replace(/\+/g,' ').replace(/[_-]+/g,' ').trim();
    }

    // set header immediately
    if(headerEl){
      headerEl.textContent = prettyServiceName(service);
    }

    const webhookValidate = "https://hook.eu2.make.com/zuqc1rgie7toaw9rll92p3mdgfsv1bld";
    const webhookAvailable = "https://hook.eu2.make.com/l7ns23v63g27prryvriwikp7bh1j75vu";
    const webhookReserveNewClient = "https://hook.eu2.make.com/2i4jvjo24m07632lbwbduvulrpy760w3";
    const webhookReserveOldClient = webhookReserveNewClient;

    const allHours = ["09:00","09:30","10:00","10:30","11:00","11:30","12:00","12:30","13:00","13:30","14:00","14:30","15:00","15:30","16:00","16:30","17:00","17:30"];

    let isOldClient = false;
    let clientInfo = {};
    let selectedSlot = { date: null, hour: null };
    let pikadayInstance = null;

    // radio handling
    const clientTypeRadios = document.querySelectorAll('input[name="clientType"]');
    const clientTypeBtn = document.getElementById("clientTypeBtn");

    clientTypeRadios.forEach(radio => {
      radio.addEventListener('change', () => {
        clientTypeBtn.disabled = false;
      });
    });

    clientTypeBtn.addEventListener('click', () => {
      const selected = document.querySelector('input[name="clientType"]:checked').value;
      isOldClient = selected === "old";
      document.getElementById('step-client').style.display = 'none';

      const randomCode = "vip_" + Math.floor(100000 + Math.random() * 900000);
      const vipInput = document.getElementById("vipCode");
      if(vipInput) vipInput.value = randomCode;

      if (isOldClient) {
        document.getElementById('step-code').style.display = 'block';
      } else {
        document.getElementById('newClientForm').style.display = 'block';
      }
    });

    async function validateCode() {
      const codeInput = document.getElementById('clientCode');
      if(!codeInput) return;
      const code = codeInput.value.trim();
      if (!code) {
        const cm = document.getElementById('codeMessage');
        if(cm) cm.textContent = "Por favor, insira o código.";
        return;
      }
      const cm = document.getElementById('codeMessage');
      if(cm) cm.textContent = "Validando...";
      try {
        const res = await fetch(webhookValidate, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code })
        });
        const result = await res.json();
        if (result.success) {
          clientInfo = result.client || {};
          clientInfo.code = code;
          document.getElementById('step-code').style.display = 'none';
          // ensure header still shows the service (no change needed)
          document.getElementById('calendarStep').style.display = 'block';
          initCalendar();
        } else {
          if(cm) cm.textContent = 'Código inválido.';
        }
      } catch (e) {
        if(cm) cm.textContent = 'Erro ao validar código.';
        console.error(e);
      }
    }

    function showCalendar() {
      // validation for new client
      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const birth = document.getElementById('birth').value.trim();

      if (!name || !email || !phone || !birth) {
        alert("Por favor, preencha todos os campos.");
        return;
      }
      clientInfo = { name, email, phone, birth, code: document.getElementById('vipCode')?.value || '' };
      document.getElementById('newClientForm').style.display = 'none';
      document.getElementById('calendarStep').style.display = 'block';
      initCalendar();
    }


   
  
    function initCalendar() {
  if (pikadayInstance) return; // جلوگیری از ساخت چندباره
  
  // محاسبه‌ی تاریخ مجاز از دو روز بعد
  const today = new Date();
  const minSelectableDate = new Date(today);
  minSelectableDate.setDate(today.getDate() + 3); // ← امروز + 3 = از 17ام قابل رزرو (14 + 3 = 17)
  
  pikadayInstance = new Pikaday({
    field: document.getElementById('datepicker'),
    format: 'DD/MM/YYYY',
    minDate: minSelectableDate, // ✅ اضافه شد
    onSelect(date) {
      const year = date.getFullYear();
      const month = (date.getMonth() + 1).toString().padStart(2, '0');
      const day = date.getDate().toString().padStart(2, '0');
      const formattedDate = `${year}-${month}-${day}`;
      selectedSlot.date = formattedDate;
      fetchAvailableSlots(formattedDate);

       // ensure header still correct (in case URL param changed or not)
       if(headerEl) headerEl.textContent = prettyServiceName(service);

     
    }
  });
}

         

    function renderTimeSlots(unavailable = []) {
      const container = document.getElementById("slots");
      if(!container) return;
      container.innerHTML = "";

      allHours.forEach(hour => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.classList.add("slot-button");
        btn.textContent = hour;

        if (unavailable.includes(hour)) {
          btn.disabled = true;
          btn.title = "Indisponível";
          btn.style.opacity = 0.5;
        } else {
          btn.addEventListener("click", () => {
            selectedSlot.hour = hour;
            document.querySelectorAll(".slot-button").forEach(b => b.classList.remove("selected"));
            btn.classList.add("selected");
          });
        }

        container.appendChild(btn);
      });
    }

    const serviceToMachine = {
  "HIFU Facial": "HIFU",
  "HIFU Corporal": "HIFU",
  "HIFU 12 Corporal": "HIFU",
  "Lipo Cavitação": "LIPO",
  "Radiofrequência Facial": "RADIO",
  "Massagem Desportiva": "MANUAL",
  "Drenagem Linfática": "MANUAL",
  // ... هر سرویس دیگه‌ای که داری
};
 
    async function fetchAvailableSlots(date) {
      if (!date) return;
      const machine = serviceToMachine[service] || service; // نوع دستگاه بر اساس سرویس
      try {
        const body = { date, ref, machine, service };
        // send service param if present, decode for readability
        if(service){
          body.service = prettyServiceName(service);
        }
        const res = await fetch(webhookAvailable, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        // attempt parse
        const data = await res.json();
        let unavailable = [];
        if (data && data.unavailableHours) {
          if (Array.isArray(data.unavailableHours)) {
            // if first element is a CSV string, flatten
            if (data.unavailableHours.length === 1 && typeof data.unavailableHours[0] === 'string' && data.unavailableHours[0].includes(',')) {
              unavailable = data.unavailableHours[0].split(',').map(s => s.trim()).filter(Boolean);
            } else {
              unavailable = data.unavailableHours.map(s => String(s).trim()).filter(Boolean);
            }
          } else if (typeof data.unavailableHours === 'string') {
            unavailable = data.unavailableHours.split(',').map(s => s.trim()).filter(Boolean);
          }
        } else if (Array.isArray(data)) {
          // webhook might return array directly
          unavailable = data.map(String).map(s=>s.trim()).filter(Boolean);
        } else if (data && data.unavailable) {
          if (Array.isArray(data.unavailable)) unavailable = data.unavailable.map(String).map(s=>s.trim()).filter(Boolean);
          else if (typeof data.unavailable === 'string') unavailable = data.unavailable.split(',').map(s=>s.trim()).filter(Boolean);
        } else if (data && data.hours && typeof data.hours === 'string') {
          unavailable = data.hours.split(',').map(s=>s.trim()).filter(Boolean);
        }

        renderTimeSlots(unavailable);
      } catch (e) {
        console.error("Erro ao buscar horários disponíveis", e);
        // fallback: render all hours enabled (or choose to disable)
        renderTimeSlots([]);
      }
    }

    // click confirm
    document.getElementById("confirmButton").addEventListener("click", async () => {
      if (!selectedSlot.date || !selectedSlot.hour) {
        document.getElementById("message").textContent = "Por favor, selecione data e hora.";
        return;
      }
      document.getElementById("message").textContent = "Enviando reserva...";

      // 👇 این قسمت اضافه شده
  const serviceToMachine = {
    "HIFU Facial": "HIFU",
    "HIFU Corporal": "HIFU",
    "HIFU 12 Corporal": "HIFU",
    "Lipo Cavitação": "LIPO",
    "Radiofrequência Facial": "RADIO",
    "Massagem Desportiva": "MANUAL",
    "Drenagem Linfática": "MANUAL",
    // سایر سرویس‌ها رو اینجا اضافه کن
  };

  const machine = serviceToMachine[service] || service; // اگر تو جدول بالا نبود، خودش فرستاده میشه


  
      const voucherCode = document.getElementById('voucherCode').value.trim();
      let payload = {
        service: prettyServiceName(service) || null,
        ref,
        date: selectedSlot.date,
        hour: selectedSlot.hour,
        voucherCode,
        clientInfo,
        machine, // 👈 این خط اضافه شد
      };

      
  // ✅ نمایش فوری پیام موفقیت
  document.getElementById("calendarStep").innerHTML = `
    <div style="padding: 30px; text-align: center;">
      <h3 style="color: #00ffcc;">✅ Reserva confirmada com sucesso!</h3>
      <p style="margin-top: 10px;">Seu horário foi reservado para <strong>${selectedSlot.date}</strong> às <strong>${selectedSlot.hour}</strong>.</p>
      <p>Você receberá um e-mail com os detalhes em breve.</p>
    </div>
  `;

  // ارسال داده‌ها به webhook مثل قبل (بدون انتظار پاسخ)
  try {
    if (isOldClient) {
      payload.clientInfo = clientInfo;
      if (!payload.clientInfo.code)
        payload.clientInfo.code = document.getElementById('clientCode').value.trim();

      fetch(webhookReserveOldClient, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      }).catch(e => console.error("Erro ao enviar reserva (cliente antigo):", e));

    } else {
      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const nationality = document.getElementById('nationality').value;
      const birth = document.getElementById('birth').value;
      const code = document.getElementById("vipCode").value.trim();
      payload.clientInfo = { name, email, phone, nationality, birth, code, ref };

      fetch(webhookReserveNewClient, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      }).catch(e => console.error("Erro ao enviar reserva (novo cliente):", e));
    }
  } catch (e) {
    console.error("Erro geral ao enviar:", e);
  }
});



    // if user arrived with a service param we set header immediately (already did at top),
    // also ensure header remains visible when calendarStep shown:
    (function ensureHeaderOnShow(){
      const origShow = document.getElementById('step-client');
      // nothing else needed — header is persistent in DOM
    })();

    // utility exposure (if you call initCalendar from elsewhere)
    window.initCalendar = initCalendar;
    window.prettyServiceName = prettyServiceName;

    // if service param exists but user wants immediate calendar view, you might auto-skip steps.
    // (Not automatic to avoid surprising user.)

  </script>
</body>
</html>
